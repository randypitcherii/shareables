{"datasets":[{"name":"1a63123c","displayName":"Alerts Log","query":"-- alerts table\nWITH daily_usage AS (\n  SELECT \n    date(usage_date) AS usage_date,\n    billing_origin_product,\n    SUM(usage_quantity) AS total_usage,\n    AVG(SUM(usage_quantity)) OVER (\n      PARTITION BY billing_origin_product \n      ORDER BY date(usage_date) \n      ROWS BETWEEN 21 PRECEDING AND CURRENT ROW\n    ) AS avg_usage,\n    STDDEV(SUM(usage_quantity)) OVER (\n      PARTITION BY billing_origin_product \n      ORDER BY date(usage_date) \n      ROWS BETWEEN 21 PRECEDING AND CURRENT ROW\n    ) AS stddev_usage,\n    MIN(date(usage_date)) OVER (PARTITION BY billing_origin_product) AS first_usage_date\n  FROM \n    system.billing.usage\n  GROUP BY \n    date(usage_date), billing_origin_product\n),\nspike_alerts AS (\n  SELECT \n    usage_date AS alert_date,\n    billing_origin_product,\n    'spike' AS alert_type,\n    total_usage AS usage_amount,\n    CONCAT('Usage exceeded average by ', ROUND((total_usage - avg_usage) / stddev_usage, 2), ' standard deviations') AS alert_description\n  FROM \n    daily_usage\n  WHERE \n    total_usage > avg_usage + 2 * stddev_usage\n),\nnew_product_alerts AS (\n  SELECT \n    usage_date AS alert_date,\n    billing_origin_product,\n    'new_product' AS alert_type,\n    total_usage AS usage_amount,\n    'New product usage detected' AS alert_description\n  FROM \n    daily_usage\n  WHERE \n    usage_date = first_usage_date\n),\nalerts AS (\n  SELECT * FROM spike_alerts\n  UNION ALL\n  SELECT * FROM new_product_alerts\n)\nSELECT \n  alert_type,\n  billing_origin_product,\n  alert_date,\n  usage_amount,\n  alert_description\nFROM \n  alerts\nORDER BY \n  alert_date DESC;\n\n\n\n"}],"pages":[{"name":"2a4d6359","displayName":"Alert Command Center","layout":[{"widget":{"name":"3cc22379","queries":[{"name":"main_query","query":{"datasetName":"1a63123c","fields":[{"name":"alert_type","expression":"`alert_type`"},{"name":"alert_date","expression":"`alert_date`"},{"name":"count(*)","expression":"COUNT(`*`)"}],"disaggregated":false}}],"spec":{"version":3,"widgetType":"bar","encodings":{"x":{"fieldName":"alert_date","scale":{"type":"temporal"},"axis":{"title":" "},"displayName":" "},"y":{"fieldName":"count(*)","scale":{"type":"quantitative"},"axis":{"title":"Alert Count"},"displayName":"Alert Count"},"color":{"fieldName":"alert_type","scale":{"type":"categorical","mappings":[{"value":"new_product","color":"#9467BD"},{"value":"spike","color":"#D62728"}]},"displayName":"alert_type"}},"frame":{"title":"Visualization 1","showTitle":false},"mark":{"layout":"stack"}}},"position":{"x":0,"y":2,"width":6,"height":5}},{"widget":{"name":"76b99d3f","queries":[{"name":"main_query","query":{"datasetName":"1a63123c","fields":[{"name":"alert_date","expression":"`alert_date`"},{"name":"alert_type","expression":"`alert_type`"},{"name":"billing_origin_product","expression":"`billing_origin_product`"},{"name":"usage_amount","expression":"`usage_amount`"},{"name":"alert_description","expression":"`alert_description`"}],"disaggregated":true}}],"spec":{"version":1,"widgetType":"table","encodings":{"columns":[{"fieldName":"alert_date","dateTimeFormat":"YYYY-MM-DD","booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"type":"date","displayAs":"datetime","visible":true,"order":0,"title":"alert_date","allowSearch":false,"alignContent":"right","allowHTML":false,"highlightLinks":false,"useMonospaceFont":false,"preserveWhitespace":false,"displayName":"alert_date"},{"fieldName":"alert_type","booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"type":"string","displayAs":"string","visible":true,"order":1,"title":"alert_type","allowSearch":false,"alignContent":"left","allowHTML":false,"highlightLinks":false,"useMonospaceFont":false,"preserveWhitespace":false,"cellFormat":{"default":{"foregroundColor":null},"rules":[{"if":{"column":"alert_type","fn":"=","literal":"spike"},"value":{"foregroundColor":"#E92828"}},{"if":{"column":"alert_type","fn":"=","literal":"new_product"},"value":{"foregroundColor":"#A58AFF"}}]},"displayName":"alert_type"},{"fieldName":"billing_origin_product","booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"type":"string","displayAs":"string","visible":true,"order":2,"title":"billing_origin_product","allowSearch":false,"alignContent":"left","allowHTML":false,"highlightLinks":false,"useMonospaceFont":false,"preserveWhitespace":false,"displayName":"billing_origin_product"},{"fieldName":"usage_amount","numberFormat":"0.00","booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"type":"decimal","displayAs":"number","visible":true,"order":3,"title":"usage_amount","allowSearch":false,"alignContent":"right","allowHTML":false,"highlightLinks":false,"useMonospaceFont":false,"preserveWhitespace":false,"displayName":"usage_amount"},{"fieldName":"alert_description","booleanValues":["false","true"],"imageUrlTemplate":"{{ @ }}","imageTitleTemplate":"{{ @ }}","imageWidth":"","imageHeight":"","linkUrlTemplate":"{{ @ }}","linkTextTemplate":"{{ @ }}","linkTitleTemplate":"{{ @ }}","linkOpenInNewTab":true,"type":"string","displayAs":"string","visible":true,"order":4,"title":"alert_description","allowSearch":false,"alignContent":"left","allowHTML":false,"highlightLinks":false,"useMonospaceFont":false,"preserveWhitespace":false,"displayName":"alert_description"}]},"invisibleColumns":[],"allowHTMLByDefault":false,"itemsPerPage":250,"paginationSize":"default","condensed":true,"withRowNumber":false,"frame":{"title":"Alerts","showTitle":false}}},"position":{"x":0,"y":7,"width":6,"height":12}},{"widget":{"name":"2e85f1a4","queries":[{"name":"dashboards/01efdf15788c1cdd93c2f8b532ebc4c9/datasets/01efdf15788d119db74c9c3dd44d4089_alert_date","query":{"datasetName":"1a63123c","fields":[{"name":"alert_date","expression":"`alert_date`"},{"name":"alert_date_associativity","expression":"COUNT_IF(`associative_filter_predicate_group`)"}],"disaggregated":false}}],"spec":{"version":2,"widgetType":"filter-date-range-picker","encodings":{"fields":[{"fieldName":"alert_date","displayName":"alert_date","queryName":"dashboards/01efdf15788c1cdd93c2f8b532ebc4c9/datasets/01efdf15788d119db74c9c3dd44d4089_alert_date"}]},"selection":{"defaultSelection":{"range":{"dataType":"DATE","min":{"value":"now/y"},"max":{"value":"now/y"}}}},"frame":{"showTitle":false,"title":""}}},"position":{"x":0,"y":0,"width":3,"height":1}},{"widget":{"name":"82262425","queries":[{"name":"dashboards/01efdf15788c1cdd93c2f8b532ebc4c9/datasets/01efdf15788d119db74c9c3dd44d4089_alert_type","query":{"datasetName":"1a63123c","fields":[{"name":"alert_type","expression":"`alert_type`"},{"name":"alert_type_associativity","expression":"COUNT_IF(`associative_filter_predicate_group`)"}],"disaggregated":false}}],"spec":{"version":2,"widgetType":"filter-multi-select","encodings":{"fields":[{"fieldName":"alert_type","displayName":"alert_type","queryName":"dashboards/01efdf15788c1cdd93c2f8b532ebc4c9/datasets/01efdf15788d119db74c9c3dd44d4089_alert_type"}]},"frame":{"showTitle":true,"title":"Alert Type"}}},"position":{"x":3,"y":0,"width":3,"height":1}},{"widget":{"name":"8536d782","queries":[{"name":"dashboards/01efdf15788c1cdd93c2f8b532ebc4c9/datasets/01efdf15788d119db74c9c3dd44d4089_billing_origin_product","query":{"datasetName":"1a63123c","fields":[{"name":"billing_origin_product","expression":"`billing_origin_product`"},{"name":"billing_origin_product_associativity","expression":"COUNT_IF(`associative_filter_predicate_group`)"}],"disaggregated":false}}],"spec":{"version":2,"widgetType":"filter-multi-select","encodings":{"fields":[{"fieldName":"billing_origin_product","displayName":"billing_origin_product","queryName":"dashboards/01efdf15788c1cdd93c2f8b532ebc4c9/datasets/01efdf15788d119db74c9c3dd44d4089_billing_origin_product"}]},"frame":{"showTitle":true,"title":"Service Type"}}},"position":{"x":3,"y":1,"width":3,"height":1}},{"widget":{"name":"136f93b7","queries":[{"name":"dashboards/01efdf15788c1cdd93c2f8b532ebc4c9/datasets/01f016db3532173181d95fc3fa8be1d7_usage_amount","query":{"datasetName":"1a63123c","fields":[{"name":"min(usage_amount)","expression":"MIN(`usage_amount`)"},{"name":"max(usage_amount)","expression":"MAX(`usage_amount`)"}],"disaggregated":false}}],"spec":{"version":2,"widgetType":"range-slider","encodings":{"fields":[{"fieldName":"usage_amount","displayName":"usage_amount","queryName":"dashboards/01efdf15788c1cdd93c2f8b532ebc4c9/datasets/01f016db3532173181d95fc3fa8be1d7_usage_amount"}]},"frame":{"showTitle":true,"title":"Cost Threshold"},"selection":{"defaultSelection":{"range":{"dataType":"DECIMAL","min":{"value":"1"},"max":{"value":""}}}}}},"position":{"x":0,"y":1,"width":3,"height":1}}]}]}
